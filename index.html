<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Streak Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-2xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold mb-4">Streak Calculator</h1>

    <!-- Input Form -->
    <div class="flex flex-col sm:flex-row gap-4 mb-6">
      <input id="goalInput" type="text" placeholder="Enter Goal" class="flex-1 p-2 border rounded" />
      <input id="dateInput" type="date" class="p-2 border rounded" />
      <button onclick="addGoal()" class="bg-blue-500 text-white px-4 py-2 rounded">Add</button>
    </div>

    <!-- Goals List -->
    <div id="goalsList" class="space-y-4"></div>
  </div>
<script>
  const STORAGE_KEY = "streak_goals";

  function getToday() {
    return new Date().toISOString().split("T")[0];
  }

  function loadGoals() {
    const stored = localStorage.getItem(STORAGE_KEY);
    return stored ? JSON.parse(stored) : [];
  }

  function saveGoals(goals) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(goals));
  }

  function addGoal() {
    const goal = document.getElementById("goalInput").value.trim();
    const date = document.getElementById("dateInput").value;

    if (!goal || !date) {
      alert("Please fill both fields.");
      return;
    }

    const goals = loadGoals();
    goals.push({
      id: Date.now(),
      goal,
      startDate: date,
      lastChecked: null,
      currentStreak: 0,
      maxStreak: 0,
      totalChecked: 0
    });

    saveGoals(goals);
    renderGoals();
    document.getElementById("goalInput").value = "";
    document.getElementById("dateInput").value = "";
  }

  function toggleCheck(id, checked) {
    const goals = loadGoals();
    const today = getToday();
    const goal = goals.find(g => g.id === id);

    if (!goal) return;

    if (checked) {
      if (goal.lastChecked === today) return;

      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yDate = yesterday.toISOString().split("T")[0];

      if (goal.lastChecked === yDate) {
        goal.currentStreak += 1;
      } else {
        goal.currentStreak = 1;
      }

      goal.maxStreak = Math.max(goal.maxStreak, goal.currentStreak);
      goal.totalChecked += 1;
      goal.lastChecked = today;
    } else {
      if (goal.lastChecked !== today) return;

      // Undo today's check
      goal.lastChecked = null;
      goal.totalChecked = Math.max(0, goal.totalChecked - 1);
      goal.currentStreak = Math.max(0, goal.currentStreak - 1);
      // maxStreak remains unchanged
    }

    saveGoals(goals);
    renderGoals();
  }

  function deleteGoal(id) {
    if (!confirm("Delete this goal?")) return;
    let goals = loadGoals();
    goals = goals.filter(goal => goal.id !== id);
    saveGoals(goals);
    renderGoals();
  }

  // NEW: Edit Goal
  function editGoal(id) {
    let goals = loadGoals();
    const goal = goals.find(g => g.id === id);
    if (!goal) return;

    const newGoalText = prompt("Edit your goal:", goal.goal);
    if (newGoalText && newGoalText.trim() !== "") {
      goal.goal = newGoalText.trim();
      saveGoals(goals);
      renderGoals();
    }
  }

  function renderGoals() {
    const container = document.getElementById("goalsList");
    let goals = loadGoals();
    const today = getToday();

    // Sort by success %
    const todayDate = new Date(getToday());
    goals.sort((a, b) => {
      const getSuccess = (g) => {
        const start = new Date(g.startDate);
        const maxPossible = Math.max(1, Math.ceil((todayDate - start) / (1000 * 60 * 60 * 24)) + 1);
        return g.totalChecked / maxPossible;
      };
      return getSuccess(b) - getSuccess(a);
    });

    container.innerHTML = "";

    goals.forEach(goal => {
      const div = document.createElement("div");
      div.className = "flex items-center justify-between border p-3 rounded";

      const info = document.createElement("div");
      info.className = "flex-1";
      info.innerHTML = `
        <p class="font-semibold">${goal.goal}</p>
        <p class="text-sm text-gray-500">Start: ${goal.startDate}</p>
      `;

      const stats = document.createElement("div");
      stats.className = "flex items-center gap-4";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = goal.lastChecked === today;
      checkbox.onclick = () => toggleCheck(goal.id, checkbox.checked);

      const editBtn = document.createElement("button");
      editBtn.textContent = "✏️";
      editBtn.title = "Edit goal";
      editBtn.className = "text-blue-500 text-lg hover:scale-110 transition-transform";
      editBtn.onclick = () => editGoal(goal.id);

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "🗑️";
      deleteBtn.title = "Delete goal";
      deleteBtn.className = "text-red-500 text-lg hover:scale-110 transition-transform";
      deleteBtn.onclick = () => deleteGoal(goal.id);

      // Calculate stats
      const start = new Date(goal.startDate);
      const diffTime = todayDate - start;
      const maxPossible = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1);
      const success = ((goal.totalChecked / maxPossible) * 100).toFixed(1);

      stats.innerHTML += `
        <div class="text-sm space-y-1">
          <p>Current Streak: <strong>${goal.currentStreak}</strong></p>
          <p>Max Streak: <strong>${goal.maxStreak}</strong></p>
          <p>Total Success: <strong>${goal.totalChecked}</strong></p>
          <p>Max Possible Streak: <strong>${maxPossible}</strong></p>
          <p>Success: <strong>${success}%</strong></p>
        </div>
      `;

      stats.prepend(checkbox);
      stats.appendChild(editBtn);
      stats.appendChild(deleteBtn);
      div.appendChild(info);
      div.appendChild(stats);
      container.appendChild(div);
    });
  }

  window.onload = renderGoals;
</script>

</body>
</html>
